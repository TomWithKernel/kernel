title: 内存调试工具

date: 2024-07-17 10:09:00

tags:

categories: dbg_meth

---

## 内存调试工具

### busybox  devmem

在Linux系统，如果我们想要访问某个寄存器，就需要写一个驱动程序，在驱动中映射寄存器地址，转为虚拟地址后就可以访问。
但有时候，我们只是单纯想知道某个寄存器的值，不想这么麻烦，怎么办呢？
Linux早就想到这一点了，于是提供了一个工具devmem，通过devmem就可以直接读写寄存器，
devmem是一个命令，在shell中输入devmem命令就可以非常方便的读写寄存器。

```shell
BusyBox v1.30.1 (Uos 1:1.30.1.5-1+dde) multi-call binary.

Usage: devmem ADDRESS [WIDTH [VALUE]]

Read/write from physical address

        ADDRESS Address to act upon		#物理地址
        WIDTH   Width (8/16/...)		#位宽
        VALUE   Data to be written		#写入
```

```shell
sudo busybox devmem 0x28007000 8     		#读取物理地址0x28007000处一个字节的数据
0x63

sudo busybox devmem 0x280070ac 8
0x01

sudo busybox devmem 0x28007000 8 0x63		#将0x63写入物理地址0x28007000

sudo busybox devmem 0x280070ac 8 0x01		#将0x01写入物理地址0x280070ac
```



### i2c-tools

应用层访问硬件肯定是需要驱动程序的。对于I2C设备，Linux内核已经提供驱动程序**`drivers/i2c/i2c-dev.c`**，通过它可以直接使用下面的I2C控制器驱动程序来访问I2C设备，而i2c-tools正是基于该驱动开发的一套示例代码，也是一套好用的调试工具。框架如下：

{% asset_img i2c-tools.png i2c-tools %}

i2c-tools 包括 ： **i2cdetect**（检测I2C器件工具） 、**i2cdump**（查看寄存器值工具） 、**i2cget**（读取寄存器值工具）、 **i2cset**（设置寄存器值工具）

#### i2cdetect

```shell
Usage: i2cdetect [-y] [-a] [-q|-r] I2CBUS [FIRST LAST]		
       i2cdetect -F I2CBUS									
       i2cdetect -l											
  I2CBUS is an integer or an I2C bus name
  If provided, FIRST and LAST limit the probing range.
  #-f		强制访问设备
  #-y		禁用交互模式
  #-a		扫描总显示所有设备
  #-l		列出已知的I2C适配器
  #I2CBUS	i2c总线编号
  #FIRST LAST	扫描地址范围
  
#返回值
#	– ：		表示该地址被检测，但没有芯片应答；
#	UU ：	表示该地址当前由内核驱动程序使用。
#	** ：	表示以十六进制表示的设备地址编号，如 “2d”或“4e”。
```

```shell
uos@uos-PC [~] ➜  sudo i2cdetect -y  0

     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- 08 -- -- -- -- -- -- -- 
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
30: 30 -- -- -- -- 35 UU UU -- -- -- -- -- -- -- -- 
40: -- -- -- -- 44 -- -- -- -- -- -- -- -- -- -- -- 
50: UU -- -- -- -- -- -- 57 -- -- -- -- -- -- -- -- 
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
70: -- -- -- -- -- -- -- -- 

uos@uos-PC [~] ➜  sudo i2cdetect -l

i2c-3   i2c             i915 gmbus dpc                          I2C adapter
i2c-1   i2c             Synopsys DesignWare I2C adapter         I2C adapter
i2c-6   i2c             AUX C/port C                            I2C adapter
i2c-4   i2c             i915 gmbus dpb                          I2C adapter
i2c-2   i2c             Synopsys DesignWare I2C adapter         I2C adapter
i2c-0   smbus           SMBus I801 adapter at efa0              SMBus adapter
i2c-7   i2c             AUX D/port D                            I2C adapter
i2c-5   i2c             i915 gmbus dpd                          I2C adapter


uos@uos-PC [~] ➜  sudo i2cdetect -F 0

Functionalities implemented by /dev/i2c-0:
I2C                              no
SMBus Quick Command              yes
SMBus Send Byte                  yes
SMBus Receive Byte               yes
SMBus Write Byte                 yes
SMBus Read Byte                  yes
SMBus Write Word                 yes
SMBus Read Word                  yes
SMBus Process Call               no
SMBus Block Write                yes
SMBus Block Read                 yes
SMBus Block Process Call         yes
SMBus PEC                        yes
I2C Block Write                  yes
I2C Block Read                   yes
```



#### i2cget

读取指定IIC设备的某个寄存器的值

```shell
Usage: i2cget [-f] [-y] [-a] I2CBUS CHIP-ADDRESS [DATA-ADDRESS [MODE]]
  I2CBUS is an integer or an I2C bus name
  ADDRESS is an integer (0x03 - 0x77, or 0x00 - 0x7f if -a is given)
  MODE is one of:
    b (read byte data, default)
    w (read word data)
    c (write byte/read byte)
    Append p for SMBus PEC
```

```shell
uos@uos-PC [~] ➜  sudo i2cget -y 0 0x57 0x00       		#读地址0x57设备的0x00处寄存器的值
0xff
```

#### i2cset

写入指定IIC设备的某个寄存器的值

```shell
Usage: i2cset [-f] [-y] [-m MASK] [-r] [-a] I2CBUS CHIP-ADDRESS DATA-ADDRESS [VALUE] ... [MODE]
  I2CBUS is an integer or an I2C bus name
  ADDRESS is an integer (0x03 - 0x77, or 0x00 - 0x7f if -a is given)
  MODE is one of:
    c (byte, no value)
    b (byte data, default)
    w (word data)
    i (I2C block data)
    s (SMBus block data)
    Append p for SMBus PEC

```

```shell
uos@uos-PC [~] ➜  sudo i2cset -y 0 0x57 0x00 0x01      		#设置地址0x57设备的0x00处寄存器的值为0x01
```

#### i2cdump

```shell
Usage: i2cdump [-f] [-y] [-r first-last] [-a] I2CBUS ADDRESS [MODE [BANK [BANKREG]]]
  I2CBUS is an integer or an I2C bus name
  ADDRESS is an integer (0x03 - 0x77, or 0x00 - 0x7f if -a is given)
  MODE is one of:
    b (byte, default)
    w (word)
    W (word on even register addresses)
    s (SMBus block)
    i (I2C block)
    c (consecutive byte)
    Append p for SMBus PEC

```

```shell
uos@uos-PC [~] ➜  sudo i2cdump -y 0 0x57   				#读取总线0  0x57处设备的所有寄存器

No size specified (using byte-data access)
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f    0123456789abcdef
00: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
10: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
20: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
30: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
40: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
50: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
60: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
70: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
80: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
90: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
a0: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
b0: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
c0: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
d0: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
e0: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
f0: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff    ................
```

